---
title: "Potential Figures for North American Ecosystem Ecology Paper"
author: 
  - Kristina Riemer
  - Dave Moore
  - name: Eric R. Scott
    orcid: 0000-0002-7430-7879
date: today
format:
  html:
    toc: true
    toc-expand: 2
    toc-location: left
    css: styles.css
    code-fold: true
execute: 
  warning: false
---

## TODO list

- Plots
  - Scale by number of years for each date
  - Do all initial plots
  - Change IGBP codes to definitions
  - Add overall trend line to interannual met variability plots
  - Facet all figures for interannual met variability
  - Simplify seasonal plot code with `tsibble::yearmonth` and `tsibble::scale_x_yearmonth`


```{r}
#| label: setup
#| output: false

library(dplyr)
library(lubridate)
library(ggplot2)
# library(amerifluxr)
library(stringr)
# library(readr)
library(purrr)
library(tidyr)
library(plotbiomes)
library(measurements) #for conv_unit()
# library(ggnewscale)
library(fs)
library(geomtextpath)
library(ggtext) #for subscripts in axis labels
library(ggforce) #for convex hulls in bowen ratios plot

#source data loading functions
source("R/fcn_utility_FLUXNET.R")

#set default ggplot2 theme
theme_set(
  theme_classic() +
    theme(axis.title.y = element_markdown(), axis.title.x = element_markdown())
)
```

## Create Data Manifest

```{r}
metadata <- load_fluxnet_metadata()
manifest <- discover_AMF_files(data_dir = here::here("data/FLUXNET/AMF")) %>% 
  distinct(
    site, data_product, dataset, time_integral, start_year, end_year,
    .keep_all = TRUE
  )
```

## Read in Data

```{r}
#| label: load-data

annual <- manifest %>%
  filter(time_integral == "YY", dataset == "FULLSET") %>%
  load_fluxnet_data() %>%                                    
  mutate(
    across(where(is.numeric), \(x) na_if(x, -9999)),
    year = as.integer(TIMESTAMP),
    .before = TIMESTAMP
  ) %>%
  left_join(metadata %>% select(-SITEID, -SITE_ID), by = join_by(site)) %>% 
  select(-path) %>%
  relocate(site, .before = 1)

daily <- manifest %>%
  filter(time_integral == "DD", dataset == "FULLSET") %>% 
  load_fluxnet_data() %>%
  mutate(
    across(where(is.numeric), \(x) na_if(x, -9999)),
    date = lubridate::ymd(TIMESTAMP),
    doy = yday(date),
    .before = TIMESTAMP
  ) %>% 
  left_join(metadata %>% select(-SITEID, -SITE_ID), by = join_by(site)) %>% 
  select(-path) %>%
  relocate(site, .before = 1)
```

```{r}
#| label: plot-labs

# Set up all the possible plot labels as objects for easy reference.  
# These get formatted by `ggtext`

lab_precip_annual <- "Precipitation (mm y<sup>-1</sup>)"
lab_gpp_daily <- "GPP (g C m<sup>-2</sup> d<sup>-1</sup>)"
lab_nee_daily <- "NEE (g C m<sup>-2</sup> d<sup>-1</sup>)"
lab_reco_daily <- "RECO (g C m<sup>-2</sup> d<sup>-1</sup>)"
lab_gpp_annual <- "GPP (g C m<sup>-2</sup> yr<sup>-1</sup>)"
lab_nee_annual <- "NEE (g C m<sup>-2</sup> yr<sup>-1</sup>)"
lab_reco_annual <- "RECO (g C m<sup>-2</sup> yr<sup>-1</sup>)"
```

## QA/QC

One site has annual precip > 60,000mm and several sites have grater than 10,000mm.  These are likely errors.  Wikipedia tells me Columbia has the highest annual precip at 3,240mm/yr

```{r}
#| code-fold: show
ggplot(annual, aes(P_F)) + geom_histogram()
```

```{r}
#| code-fold: show
annual <- annual %>% filter(P_F < 7500)
ggplot(annual, aes(P_F)) + geom_histogram()
```


## Figures

Find all variables described on the [FULLSET Data Product page](https://fluxnet.org/data/fluxnet2015-dataset/fullset-data-product/). Plots are generally of 3 variables: 

1. GPP_NT_VUT_REF
2. RECO_NT_VUT_REF
3. NEE_VUT_REF

### Entire time series (single site)

Lots of ways to smooth time series (i.e., filter)

- Simple running mean from [this book chapter](https://cswr.nrhstat.org/timeseries)
- Takes mean of value and (n-1) / 2 values on either side of it
- Bigger window size = more averaging

```{r}
window_size <- 51
```

```{r}
#| warning: false

total_ts_gpp <- daily %>%
  filter(site == last(site)) |>
  mutate(
    running_mean_gpp = stats::filter(
      GPP_NT_VUT_REF,
      rep(1 / window_size, window_size)
    )
  )

yr_start_dates <- total_ts_gpp %>%
  filter(grepl("-01-01", date)) %>%
  pull(date)

ggplot(total_ts_gpp, aes(x = date, y = GPP_NT_VUT_REF)) +
  geom_point(size = 0.5, color = "darkgrey") +
  geom_line(aes(y = running_mean_gpp), color = "blue", lwd = 1) +
  geom_vline(xintercept = yr_start_dates, color = "grey", alpha = 0.5) +
  labs(x = "Date", y = lab_gpp_daily)

total_ts_reco <- daily %>%
  filter(site == last(site)) |>
  mutate(
    running_mean_reco = stats::filter(
      RECO_NT_VUT_REF,
      rep(1 / window_size, window_size)
    )
  )

ggplot(total_ts_reco, aes(x = date, y = RECO_NT_VUT_REF)) +
  geom_point(size = 0.5, color = "darkgrey") +
  geom_line(aes(y = running_mean_reco), color = "blue", lwd = 1) +
  geom_vline(xintercept = yr_start_dates, color = "grey", alpha = 0.5) +
  labs(x = "Date", y = lab_reco_daily)

total_ts_nee <- daily %>%
  filter(site == last(site)) |>
  mutate(
    running_mean_nee = stats::filter(
      NEE_VUT_REF,
      rep(1 / window_size, window_size)
    )
  )

ggplot(total_ts_nee, aes(x = date, y = NEE_VUT_REF)) +
  geom_point(size = 0.5, color = "darkgrey") +
  geom_line(aes(y = running_mean_nee), color = "blue", lwd = 1) +
  geom_vline(xintercept = yr_start_dates, color = "grey", alpha = 0.5) +
  labs(x = "Date", y = lab_nee_daily)
```

### Entire time series (multiple sites)

Same smoother as used for single site. 

```{r}
#| warning: false
#| 
total_ts_ms <- daily %>%
  group_by(site) %>%
  mutate(
    running_mean_gpp = stats::filter(
      GPP_NT_VUT_REF,
      rep(1 / window_size, window_size)
    ),
    running_mean_reco = stats::filter(
      RECO_NT_VUT_REF,
      rep(1 / window_size, window_size)
    ),
    running_mean_nee = stats::filter(
      NEE_VUT_REF,
      rep(1 / window_size, window_size)
    )
  )

yr_start_dates_ms <- total_ts_ms %>%
  filter(grepl("-01-01", date)) %>%
  pull(date)
```

Show entire time series of GPP for all sites, with points for daily values.

```{r}
#| code-fold: true
#| warning: false

ggplot(
  total_ts_ms,
  aes(
    x = date,
    y = GPP_NT_VUT_REF,
    color = COUNTRY,
    fill = COUNTRY,
    group = site
  )
) +
  geom_point(size = 0.1, alpha = 0.1) +
  geom_vline(xintercept = yr_start_dates_ms, color = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0, color = "grey", alpha = 0.5, linetype = "dashed") +
  facet_grid(vars(IGBP)) +
  guides(color = guide_legend(override.aes = list(alpha = 1, size = 3))) +
  labs(x = "Date", y = lab_gpp_daily) 

ggplot(
  total_ts_ms,
  aes(
    x = date,
    y = RECO_NT_VUT_REF,
    color = COUNTRY,
    fill = COUNTRY,
    group = site
  )
) +
  geom_point(size = 0.1, alpha = 0.1) +
  geom_vline(xintercept = yr_start_dates_ms, color = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0, color = "grey", alpha = 0.5, linetype = "dashed") +
  facet_grid(vars(IGBP)) +
  guides(colour = guide_legend(override.aes = list(alpha = 1, size = 3))) +
  labs(x = "Date", y = lab_reco_daily)

ggplot(
  total_ts_ms,
  aes(
    x = date,
    y = NEE_VUT_REF,
    color = COUNTRY,
    fill = COUNTRY,
    group = site
  )
) +
  geom_point(size = 0.1, alpha = 0.1) +
  geom_vline(xintercept = yr_start_dates_ms, color = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0, color = "grey", alpha = 0.5, linetype = "dashed") +
  facet_grid(vars(IGBP)) +
  guides(colour = guide_legend(override.aes = list(alpha = 1, size = 3))) +
  labs(x = "Date", y = lab_nee_daily) 
```

Show entire time series of GPP for all sites, with daily values smoothed out as a line. 

```{r}
#| code-fold: true
#| warning: false

ggplot(
  total_ts_ms,
  aes(x = date, y = running_mean_gpp, color = COUNTRY, group = site)
) +
  geom_line(lwd = 0.5, alpha = 0.7) +
  geom_vline(xintercept = yr_start_dates_ms, color = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0, color = "grey", alpha = 0.5, linetype = "dashed") +
  facet_grid(vars(IGBP)) +
  labs(x = "Date", y = lab_gpp_daily) +
  theme(panel.background = element_rect(color = "black"))

ggplot(
  total_ts_ms,
  aes(x = date, y = running_mean_reco, color = COUNTRY, group = site)
) +
  geom_line(lwd = 0.5, alpha = 0.7) +
  geom_vline(xintercept = yr_start_dates_ms, color = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0, color = "grey", alpha = 0.5, linetype = "dashed") +
  facet_grid(vars(IGBP)) +
  labs(x = "Date", y = lab_reco_daily) +
  theme(panel.background = element_rect(color = "black"))

ggplot(
  total_ts_ms,
  aes(x = date, y = running_mean_nee, color = COUNTRY, group = site)
) +
  geom_line(lwd = 0.5, alpha = 0.7) +
  geom_vline(xintercept = yr_start_dates_ms, color = "grey", alpha = 0.5) +
  geom_hline(yintercept = 0, color = "grey", alpha = 0.5, linetype = "dashed") +
  facet_grid(vars(IGBP)) +
  labs(x = "Date", y = lab_nee_daily) +
  theme(panel.background = element_rect(color = "black"))
```

### Average annual time series (single site)

Show average daily values (with standard deviations)

```{r}
#| code-fold: true

# get averages by date across years
gpp_by_date <- daily %>%
  filter(site == last(site)) |>
  group_by(doy) %>%
  summarize(
    gpp_mean = mean(GPP_NT_VUT_REF, na.rm = TRUE),
    gpp_sd = sd(GPP_NT_VUT_REF, na.rm = TRUE)
  )

ggplot(gpp_by_date, aes(x = doy, y = gpp_mean)) +
  geom_ribbon(
    aes(ymax = gpp_mean + gpp_sd, ymin = gpp_mean - gpp_sd),
    fill = "grey"
  ) +
  geom_point() +
  labs(
    x = "DOY",
    y = lab_gpp_daily
  )

reco_by_date <- daily %>%
  filter(site == last(site)) |>
  group_by(doy) %>%
  summarize(
    reco_mean = mean(RECO_NT_VUT_REF),
    reco_sd = sd(RECO_NT_VUT_REF)
  )

ggplot(reco_by_date, aes(x = doy, y = reco_mean)) +
  geom_ribbon(
    aes(ymax = reco_mean + reco_sd, ymin = reco_mean - reco_sd),
    fill = "grey"
  ) +
  geom_point() +
  labs(
    x = "DOY",
    y = lab_reco_daily
  )

nee_by_date <- daily %>%
  filter(site == last(site)) |>
  group_by(doy) %>%
  summarize(nee_mean = mean(NEE_VUT_REF), nee_sd = sd(NEE_VUT_REF))

ggplot(nee_by_date, aes(x = doy, y = nee_mean)) +
  geom_ribbon(
    aes(ymax = nee_mean + nee_sd, ymin = nee_mean - nee_sd),
    fill = "grey"
  ) +
  geom_point() +
  labs(
    x = "DOY",
    y = lab_nee_daily
  ) 

```

### Average annual time series (multiple sites)

Textbook figures: 

![](textbook_figures/seasonal_gpp_nee.png)

Show average daily values by site (symbols) and vegetation type (colors)

```{r}
#| warning: false

# Get mean by week and IGBP
flux_weekly <-
  daily %>%
  mutate(week = week(date), .after = doy) %>%
  group_by(IGBP, week) %>%
  summarize(across(c(GPP_NT_VUT_REF, RECO_NT_VUT_REF, NEE_VUT_REF), \(x) {
    mean(x, na.rm = TRUE)
  })) %>%
  # create a fake date to use as axis labels
  mutate(fake_date = ymd("2020-01-01") + weeks(week))

ggplot(
  flux_weekly,
  aes(x = fake_date, y = GPP_NT_VUT_REF, color = IGBP, shape = IGBP)
) +
  geom_point() +
  geom_line() +
  scale_color_discrete_qualitative() +
  scale_shape_manual(values = 0:16) +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  labs(x = "", y = lab_gpp_daily) +
  theme(axis.title.y = element_markdown())

ggplot(
  flux_weekly,
  aes(x = fake_date, y = NEE_VUT_REF, color = IGBP, shape = IGBP)
) +
  geom_point() +
  geom_line() +
  scale_color_discrete_qualitative() +
  scale_shape_manual(values = 0:16) +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  labs(x = "", y = lab_nee_daily) +
  theme(axis.title.y = element_markdown())

ggplot(
  flux_weekly,
  aes(x = fake_date, y = RECO_NT_VUT_REF, color = IGBP, shape = IGBP)
) +
  geom_point() +
  geom_line() +
  scale_color_discrete_qualitative() +
  scale_shape_manual(values = 0:16) +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  labs(x = "", y = lab_reco_daily) +
  theme(axis.title.y = element_markdown())

```

### Comparison to meteorological variables (multiple sites)

Textbook figure (for NEE): 

![](textbook_figures/meteo_comp.png)

Meteorological variables (bold indicates variable in figures): 

1. P: Precipitation - not in annual datasets
2. P_ERA: Precipitation, downscaled from ERA, linearly regressed using measured only site data
3. **P_F**: Precipitation consolidated from P and P_ERA
4. TA_F_MDS: Air temperature, gapfilled using MDS method
5. TA_ERA: Air temperature, downscaled from ERA, linearly regressed using measured only site data
6. **TA_F**: Air temperature, consolidated from TA_F_MDS and TA_ERA

Show annual precipitation, summed from daily data, against three main variables annually. 

```{r}
#| code-fold: true
#| warning: false

annual |>
  filter(!is.na(GPP_NT_VUT_REF)) |>
  ggplot(aes(x = P_F, y = GPP_NT_VUT_REF)) +
  geom_point(aes(color = IGBP, group = site)) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = lab_precip_annual, y = lab_gpp_annual)

annual |>
  filter(!is.na(RECO_NT_VUT_REF)) |>
  ggplot(aes(x = P_F, y = RECO_NT_VUT_REF)) +
  geom_point(aes(color = IGBP, group = site)) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = lab_precip_annual, y = lab_reco_annual)

annual |>
  filter(!is.na(NEE_VUT_REF)) |>
  ggplot(aes(x = P_F, y = NEE_VUT_REF)) +
  geom_point(aes(color = IGBP, group = site)) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = lab_precip_annual, y = lab_nee_annual)
```

Show annual temperature, averaged from daily data, against three main variables annually. 

```{r}
#| code-fold: true
#| warning: false

annual |>
  ggplot(aes(x = TA_F, y = GPP_NT_VUT_REF)) +
  geom_point(aes(color = IGBP, group = site)) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Temperature (ºC)", y = lab_gpp_annual)

annual |>
  ggplot(aes(x = TA_F, y = RECO_NT_VUT_REF)) +
  geom_point(aes(color = IGBP, group = site)) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Temperature (ºC)", y = lab_reco_annual)

annual |>
  ggplot(aes(x = TA_F, y = NEE_VUT_REF)) +
  geom_point(aes(color = IGBP, group = site)) +
  geom_smooth(se = FALSE, color = "black") +
  labs(x = "Temperature (ºC)", y = lab_nee_annual)
```

::: {.callout-tip}
## Questions

1. We want to do this for evapotranspiration; which variable is that in the dataset? 
2. Do precipitation variable P and temp variable TA_F_MDS come from measured site data? 
3. We could get some measure of variability for x- (temp and precip) and y- (GPP, RECO, NEE) axes by using the daily or monthly values instead; would that be of interest? 
:::

### Interannual comparison to meteorological variables (multiple sites)

Textbook figure (for NPP): 

![](textbook_figures/interannual_meteo_comp.png)

```{r}
ggplot(annual, aes(x = P_F, y = RECO_NT_VUT_REF)) +
  geom_smooth(se = FALSE, color = "black", linewidth = 0.5) +
  # geom_smooth(se = FALSE, aes(color = site), method = "lm") +
  geom_textsmooth(
    aes(color = IGBP, label = IGBP),
    se = FALSE,
    method = "lm",
    offset = unit(5, "pt"),
    gap = FALSE,
    # textcolor = "black",
    size = 3
  ) +
  labs(x = lab_precip_annual, y = lab_reco_annual) +
  guides(color = "none")
```

### Bowen ratios

Textbook figure: 

![](textbook_figures/bowen_ratios.png)

Heat flux variables (bold indicates variable in figures): 

- **H_F_MDS**: Sensible heat flux, gapfilled using MDS method (W m-2)
- H_CORR (H_CORR_25, H_CORR_75): Sensible heat flux, corrected H_F_MDS by energy balance closure correction factor (25th and 75th percentile) 
- **LE_F_MDS**: Latent heat flux, gapfilled using MDS method
- LE_CORR (LE_CORR_25, LE_CORR_75): Latent heat flux, corrected LE_F_MDS by energy balance closure correction factor (25th and 75th percentile) 


Visual check of heat flux variable ranges. 
```{r}
#| message: false
# ggplot(fluxnet_daily, aes(x = LE_F_MDS)) +
#   geom_histogram() +
#   facet_wrap(vars(SITE_ID)) +
#   theme_bw()

# ggplot(fluxnet_daily, aes(x = H_F_MDS)) +
#   geom_histogram() +
#   facet_wrap(vars(SITE_ID)) +
#   theme_bw()
```

Show average daily summer-only sensible vs latent heat flux (i.e., Bowen ratio) for multiple sites with different vegetation types. Bowen ratios of 3, 2, 1, 0.5, and 0.25 shown by dotted lines. 

```{r}
#| code-fold: true

multiple_sites_flux <- daily %>%
  filter(month(date) %in% c(6:8)) %>% #filter to include summer only
  group_by(site, IGBP) %>%
  summarize(
    latent_heat_flux = mean(LE_F_MDS),
    sensible_heat_flux = mean(H_F_MDS)
  )

upper_axis_limit <- pmax(
  max(multiple_sites_flux$sensible_heat_flux),
  max(multiple_sites_flux$latent_heat_flux)
) +
  10

ggplot(
  multiple_sites_flux,
  aes(x = latent_heat_flux, y = sensible_heat_flux, color = IGBP)
) +
  geom_point(size = 3) +
  # geom_mark_hull(expand = unit(1, "mm")) + #looks ridiculous
  geom_mark_ellipse(
    aes(
      label = IGBP,
      fill = IGBP,
      filter = IGBP %in% c("OSH", "CRO", "DBF") #highlight just a few?
    ),
    label.fill = "inherit"
  ) +
  geom_abline(
    slope = c(0.25, 0.5, 1, 2, 3),
    linetype = "dotted",
    color = "darkgrey"
  ) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, upper_axis_limit)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, upper_axis_limit)) +
  # guides(x.sec = "axis", y.sec = "axis") +
  guides(fill = "none") +
  labs(
    x = "Latent Heat Flux (W m<sup>-2</sup>)",
    y = "Sensible Heat Flux (W m<sup>-2</sup>)"
  ) +
  theme(
    panel.border = element_rect(fill = NA),
    axis.title = element_markdown()
  )

```


### Biome plot

Textbook figure: 

![](textbook_figures/biomes.png)

The R package [`plotbiomes`](https://github.com/valentinitnelav/plotbiomes) can be used to recreate the base plot here, which is referred to as a [Whittaker plot](https://en.wikipedia.org/wiki/Biome#Whittaker_(1962,_1970,_1975)_biome-types). It includes a dataset of temperature, precipitation, and associated biome. 

```{r}
#| include: false
data("Whittaker_biomes")
head(Whittaker_biomes)
unique(Whittaker_biomes$biome)
```

Get mean values of annual precipitation (P_F) and temperature (TA_F) for each site, and convert precipitation to match Whittaker dataset units (mm/yr to cm/yr). 

```{r}
whittaker_format <- annual %>%
  group_by(site, IGBP) %>%
  summarize(mean_precip = mean(P_F, na.rm = TRUE), mean_temp = mean(TA_F, na.rm = TRUE)) %>%
  mutate(mean_precip_cm = conv_unit(mean_precip, "mm", "cm"))
```

Show mean annual precipitation and temperature of each site over Whittaker biome. 

```{r}
ggplot() +
  geom_polygon(
    data = Whittaker_biomes,
    aes(x = temp_c, y = precp_cm, fill = biome),
    # fill = "white"
    alpha = 0.4
  ) +
  # scale_fill_brewer(palette = "BrBG") +
  scale_fill_manual(
    name = "Whittaker biomes",
    breaks = names(Ricklefs_colors),
    labels = names(Ricklefs_colors),
    values = Ricklefs_colors
  ) +
  # new_scale_color() +
  geom_point(
    data = whittaker_format,
    aes(x = mean_temp, y = mean_precip_cm, color = IGBP)
  ) +
  # scale_color_brewer(palette = "Set1") +
  labs(x = "Temperature (C)", y = "Precipitation (cm y-1)") +
  guides(color = guide_legend(ncol = 3))
```

::: {.callout-tip}
## Questions

1. How suspicious are sites that don't exist in a biome?
:::

### Daily energy flux (single site)

Textbook figure: 

![](textbook_figures/daily_energy_flux.png)

The energy flux variables are listed below. The ones that have multiple possible options are discussed below in the questions section. 

- NETRAD: Net radiation
- SW_IN_F: Shortwave radiation, incoming consolidated from SW_IN_F_MDS and SW_IN_ERA (negative values set to zero)
- SW_OUT: Shortwave radiation, outgoing
- LW_IN_F: Longwave radiation, incoming, consolidated from LW_IN_F_MDS and LW_IN_ERA
- LW_OUT: Longwave radiation, outgoing

Parsing dates and times: 

```{r}
#| eval: false

#not working currently
rad_dt <- single_site_hourly %>%
  mutate(
    date = date(datetime_start),
    time = format(as.POSIXct(datetime_start), format = '%H:%M')
  )
```

Show average half-hourly shortwave, longwave, and total radiation for a single site. Data collection starts `min(rad_dt$date)` and ends `max(rad_dt$date)`. 

```{r}
#| code-fold: true
#| eval: false

rad_means <- rad_dt %>%
  group_by(time) %>%
  summarise(
    rn_mean = mean(NETRAD),
    sw_in_mean = mean(SW_IN_F),
    sw_out_mean = mean(SW_OUT),
    lw_in_mean = mean(LW_IN_F),
    lw_out_mean = mean(LW_OUT)
  ) %>%
  pivot_longer(
    !time,
    names_to = "energy_flux_var",
    values_to = "energy_flux_value"
  ) %>%
  mutate(
    energy_flux_var = factor(
      energy_flux_var,
      levels = c(
        "rn_mean",
        "sw_in_mean",
        "sw_out_mean",
        "lw_in_mean",
        "lw_out_mean"
      )
    )
  )

ggplot(rad_means, aes(x = time, y = energy_flux_value)) +
  geom_line(aes(group = energy_flux_var, linetype = energy_flux_var)) +
  geom_hline(yintercept = 0) +
  #geom_point() +
  labs(x = "Time (hr)", y = "Energy flux (W m-2)") +
  theme_minimal() +
  scale_x_discrete(
    breaks = c("00:00", "04:00", "08:00", "12:00", "16:00", "20:00")
  ) +
  scale_linetype_manual(
    values = c("solid", "dotted", "dotted", "dashed", "dashed")
  )

```

::: {.callout-tip}
## Questions

1. Why does this not really line up with the textbook image? *Because this is real data. We will investigate more later*
2. There are a few options for shortwave in besides SW_IN_F: SW_IN_POT, SW_IN_F_MDS, SW_IN_ERA. Which of these is the one we want? *Yes*
3. Longwave in also has those options, plus JSB ones. *Also yes*
4. Add standard deviation to these means? 
:::

Textbook figure for APAR vs GPP for two sites: 

![](textbook_figures/apar.png)

Show photosynthetically active radiation to GPP. 

::: {.callout-tip}
# Question

**Which dataset is APAR in?** It's listed in the [data variables page](https://fluxnet.org/data/aboutdata/data-variables/), but not on the [fullset page](https://fluxnet.org/data/fluxnet2015-dataset/fullset-data-product/) or in the single site hourly, daily, or annual datasets. Other **MET_RAD** variables like SW/LW radiation and photon flux density are in those datsets. Also not in BADM. 
:::