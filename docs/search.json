[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "FLUXNET Demo Plots (with Global Maps)",
    "section": "",
    "text": "Code\nlibrary(here)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(readr)\nlibrary(purrr)\nlibrary(stringr)\nlibrary(units)\nlibrary(ggnewscale)\n\n# Extra packages needed for Eric's maps\nsuppressPackageStartupMessages({\n  library(sf)\n  library(ggtext)\n  library(patchwork)\n  library(colorspace)\n  library(cols4all)\n  library(rnaturalearth)\n})\n\nset.seed(123)\n\nif (!params$use_terra) {\n  suppressPackageStartupMessages(library(raster))\n} else {\n  suppressPackageStartupMessages(library(terra))\n}\n\nlibrary(plotbiomes)\n\n# Prevent namespace conflicts with 'raster'\nselect &lt;- dplyr::select\nfilter &lt;- dplyr::filter\nlag    &lt;- dplyr::lag\n\n# Project helpers\nsource(\"R/fcn_utility_FLUXNET.R\")\nsource(\"R/fcn_plot_FLUXNET.R\")\n\n# Figure dir + helper\nfig_dir &lt;- here::here(\"figs\")\nif (!dir.exists(fig_dir)) dir.create(fig_dir, recursive = TRUE)\n\nsave_if &lt;- function(p, name, width = 7, height = 5, dpi = 300) {\n  if (isTRUE(params$save_figs)) {\n    ggsave(file.path(fig_dir, paste0(name, \".png\")), p, width = width, height = height, dpi = dpi)\n  }\n  p\n}"
  },
  {
    "objectID": "index.html#site-map-by-record-length",
    "href": "index.html#site-map-by-record-length",
    "title": "FLUXNET Demo Plots (with Global Maps)",
    "section": "5.1 Site map by record length",
    "text": "5.1 Site map by record length\n\n\nCode\nworld &lt;- rnaturalearth::ne_countries(scale = \"medium\", returnclass = \"sf\") |&gt;\n  dplyr::filter(continent != \"Antarctica\")\n\nsite_yrs &lt;- annual_std |&gt;\n  dplyr::group_by(site) |&gt;\n  dplyr::summarize(n_yrs = dplyr::n_distinct(year), .groups = \"drop\") |&gt;\n  dplyr::left_join(metadata, dplyr::join_by(site)) |&gt;\n  dplyr::filter(!is.na(LOCATION_LONG), !is.na(LOCATION_LAT)) |&gt;\n  sf::st_as_sf(coords = c(\"LOCATION_LONG\",\"LOCATION_LAT\"), crs = 4326)\n\n# BBoxes from sites (avoid typos like 'Portugul')\nbbox_na &lt;- site_yrs |&gt;\n  dplyr::filter(COUNTRY %in% c(\"USA\",\"United States of America\",\"Canada\",\"Mexico\",\"Panama\",\"Costa Rica\")) |&gt;\n  sf::st_bbox()\n\nbbox_eu &lt;- site_yrs |&gt;\n  dplyr::filter(COUNTRY %in% c(\n    \"Belgium\",\"Switzerland\",\"Czechia\",\"Germany\",\"Denmark\",\"Spain\",\"Finland\",\n    \"France\",\"Italy\",\"Netherlands\",\"Norway\",\"Portugal\",\"Sweden\",\"United Kingdom\",\n    \"UK\",\"Ireland\",\"Austria\",\"Poland\"\n  )) |&gt;\n  sf::st_bbox()\n\nbase &lt;- ggplot() +\n  geom_sf(data = world, fill = \"white\") +\n  geom_sf(data = site_yrs, aes(color = n_yrs), size = 0.5) +\n  scale_color_continuous_sequential(palette = \"Viridis\", rev = FALSE, end = 0.9) +\n  theme_void() +\n  theme(panel.background = element_rect(fill = \"lightblue\", color = \"black\"))\n\np_world &lt;- base + coord_sf(expand = FALSE)\np_na    &lt;- base + coord_sf(xlim = c(bbox_na[\"xmin\"], bbox_na[\"xmax\"]),\n                           ylim = c(bbox_na[\"ymin\"], bbox_na[\"ymax\"]))\np_eu    &lt;- base + coord_sf(xlim = c(bbox_eu[\"xmin\"], bbox_eu[\"xmax\"]),\n                           ylim = c(bbox_eu[\"ymin\"], bbox_eu[\"ymax\"]))\n\np_site_years &lt;- p_world / (p_eu | p_na) +\n  patchwork::plot_layout(widths = c(1, 0.4, 0.6), guides = \"collect\") &\n  labs(color = \"# yrs\")\n\nsave_if(p_site_years, \"eric_n_yrs_site_map\", width = 10, height = 8)\n\n\n\n\n\nSites colored by number of years of data; main panel plus focus on Europe and North America.\n\n\n\n\nCode\np_site_years\n\n\n\n\n\nSites colored by number of years of data; main panel plus focus on Europe and North America."
  },
  {
    "objectID": "index.html#site-map-by-igbp",
    "href": "index.html#site-map-by-igbp",
    "title": "FLUXNET Demo Plots (with Global Maps)",
    "section": "5.2 Site map by IGBP",
    "text": "5.2 Site map by IGBP\n\n\nCode\nmetadata_sf &lt;- metadata |&gt;\n  dplyr::filter(!is.na(LOCATION_LONG), !is.na(LOCATION_LAT)) |&gt;\n  sf::st_as_sf(coords = c(\"LOCATION_LONG\",\"LOCATION_LAT\"), crs = 4326)\n\nbase2 &lt;- ggplot() +\n  geom_sf(data = world, fill = \"white\") +\n  geom_sf(data = metadata_sf, aes(color = IGBP), size = 0.5, key_glyph = \"rect\") +\n  scale_color_discrete_qualitative() +\n  theme_void() +\n  theme(panel.background = element_rect(fill = \"lightblue\", color = \"black\"))\n\np_world2 &lt;- base2 + coord_sf(expand = FALSE)\np_na2    &lt;- base2 + coord_sf(xlim = c(bbox_na[\"xmin\"], bbox_na[\"xmax\"]),\n                             ylim = c(bbox_na[\"ymin\"], bbox_na[\"ymax\"]))\np_eu2    &lt;- base2 + coord_sf(xlim = c(bbox_eu[\"xmin\"], bbox_eu[\"xmax\"]),\n                             ylim = c(bbox_eu[\"ymin\"], bbox_eu[\"ymax\"]))\n\np_igbp &lt;- p_world2 / (p_eu2 | p_na2) +\n  patchwork::plot_layout(widths = c(1, 0.4, 0.6), guides = \"collect\") &\n  labs(color = \"IGBP\")\n\nsave_if(p_igbp, \"eric_igbp_site_map\", width = 10, height = 8)\n\n\n\n\n\nSites colored by IGBP class; main panel plus focus on Europe and North America.\n\n\n\n\nCode\np_igbp\n\n\n\n\n\nSites colored by IGBP class; main panel plus focus on Europe and North America."
  },
  {
    "objectID": "index.html#current-vs-historical-flux-maps",
    "href": "index.html#current-vs-historical-flux-maps",
    "title": "FLUXNET Demo Plots (with Global Maps)",
    "section": "5.3 Current vs historical flux maps",
    "text": "5.3 Current vs historical flux maps\n\n\nCode\nannual_hist &lt;- annual_std |&gt;\n  dplyr::select(site, year, dplyr::all_of(vars_of_interest)) |&gt;\n  dplyr::filter(year &lt; max(year, na.rm = TRUE)) |&gt;\n  dplyr::summarize(dplyr::across(dplyr::all_of(vars_of_interest), ~mean(.x, na.rm = TRUE)),\n                   .by = site)\n\nannual_curr &lt;- annual_std |&gt;\n  dplyr::select(site, year, dplyr::all_of(vars_of_interest)) |&gt;\n  dplyr::filter(year == max(year, na.rm = TRUE)) |&gt;\n  dplyr::summarize(dplyr::across(dplyr::all_of(vars_of_interest), ~mean(.x, na.rm = TRUE)),\n                   .by = site)\n\nplot_df &lt;- dplyr::bind_rows(\n  dplyr::mutate(annual_hist, period = \"hist\"),\n  dplyr::mutate(annual_curr, period = \"curr\")\n) |&gt;\n  tidyr::pivot_longer(c(-site, -period)) |&gt;\n  tidyr::pivot_wider(names_from = period, values_from = value) |&gt;\n  dplyr::mutate(diff = curr - hist) |&gt;\n  tidyr::pivot_wider(names_from = name, values_from = c(hist, curr, diff)) |&gt;\n  dplyr::left_join(metadata |&gt; dplyr::select(site, LOCATION_LAT, LOCATION_LONG), dplyr::join_by(site)) |&gt;\n  dplyr::filter(is.finite(LOCATION_LONG), is.finite(LOCATION_LAT)) |&gt;\n  sf::st_as_sf(coords = c(\"LOCATION_LONG\",\"LOCATION_LAT\"), crs = 4326)\n\nmake_pair &lt;- function(var){\n  lab &lt;- stringr::str_extract(var, \"GPP|NEE|RECO\")\n  var_hist &lt;- paste0(\"hist_\", var)\n  var_diff &lt;- paste0(\"diff_\", var)\n\n  p1 &lt;- plot_df |&gt;\n    dplyr::filter(dplyr::if_all(dplyr::all_of(var_hist), is.finite)) |&gt;\n    ggplot() +\n    geom_sf(data = world, fill = \"white\") +\n    geom_sf(aes(color = .data[[var_hist]]), size = 0.4, na.rm = TRUE) +\n    labs(color = paste0(lab, \" gC m&lt;sup&gt;-2&lt;/sup&gt; y&lt;sup&gt;-1&lt;/sup&gt;\")) +\n    coord_sf(expand = FALSE) +\n    theme_void() +\n    theme(legend.title = ggtext::element_markdown(),\n          legend.position = \"bottom\",\n          legend.key.width = grid::unit(1, \"null\"),\n          panel.background = element_rect(fill = \"lightblue\", color = \"black\"))\n\n  if (lab == \"NEE\") {\n    p1 &lt;- p1 + cols4all::scale_color_continuous_c4a_div(\"met.troy\")\n  } else {\n    p1 &lt;- p1 + scale_color_continuous_sequential(palette = \"Viridis\")\n  }\n\n  p2 &lt;- plot_df |&gt;\n    dplyr::filter(dplyr::if_all(dplyr::all_of(var_diff), is.finite)) |&gt;\n    ggplot() +\n    geom_sf(data = world, fill = \"white\") +\n    geom_sf(aes(color = .data[[var_diff]]), size = 0.4, na.rm = TRUE) +\n    scale_color_continuous_diverging() +\n    labs(color = paste0(lab, \" gC m&lt;sup&gt;-2&lt;/sup&gt; y&lt;sup&gt;-1&lt;/sup&gt;\")) +\n    coord_sf(expand = FALSE) +\n    theme_void() +\n    theme(legend.title = ggtext::element_markdown(),\n          legend.position = \"bottom\",\n          legend.key.width = grid::unit(1, \"null\"),\n          panel.background = element_rect(fill = \"lightblue\", color = \"black\"))\n\n  p1 | p2\n}\n\np_list &lt;- lapply(vars_of_interest, make_pair)\np_fluxmaps &lt;- patchwork::wrap_plots(p_list, ncol = 1) + patchwork::plot_annotation(tag_levels = \"a\")\n\n\n\n\nCode\nsave_if(p_fluxmaps, \"eric_flux_maps\", width = 10, height = 8)\n\n\n\n\n\nFluxes averaged over all prior years (left in each row) and the current year minus prior mean (right).\n\n\n\n\nCode\np_fluxmaps\n\n\n\n\n\nFluxes averaged over all prior years (left in each row) and the current year minus prior mean (right)."
  }
]