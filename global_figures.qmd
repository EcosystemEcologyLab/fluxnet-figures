---
title: "Global Fluxnet Figures"
authors:
    - name: Eric R. Scott
      orcid: 0000-0002-7430-7879
format: 
  html:
    fig-width: 10
    fig-height: 10
execute: 
  freeze: auto
---


```{r}
#| label: setup
#| message: false
#| code-fold: true
library(dplyr)
library(tsibble)
library(purrr)
library(ggplot2)
library(ggtext)
library(patchwork)
library(sf)
library(colorspace)
library(rnaturalearth)
source("R/fcn_utility_FLUXNET.R")

```

## Load Data

```{r}
#| label: data
#| cache: true
#| collapse: true

metadata <- load_fluxnet_metadata()
amf_files <- discover_AMF_files(data_dir = "data/AMF")
icos_files <- discover_ICOS_files(data_dir = "data/ICOS")
manifest <- bind_rows(amf_files, icos_files)

# deduplicate manifest?
manifest <- manifest %>%
  distinct(
    site,
    data_product,
    dataset,
    time_integral,
    start_year,
    end_year,
    .keep_all = TRUE
  )
annual <- manifest %>%
  filter(time_integral == "YY") %>%
  load_fluxnet_data() %>%
  mutate(across(where(is.numeric), \(x) na_if(x, -9999))) %>%
  mutate(year = as.integer(TIMESTAMP), .before = TIMESTAMP) %>%
  left_join(metadata %>% select(-SITEID, -SITE_ID), by = join_by(site))

monthly <- manifest %>%
  filter(time_integral == "MM") %>%
  load_fluxnet_data() %>%
  mutate(across(where(is.numeric), \(x) na_if(x, -9999))) %>%
  mutate(
    yearmonth = tsibble::yearmonth(as.character(TIMESTAMP), format = "%Y%m"),
    .before = TIMESTAMP
  ) %>%
  left_join(metadata %>% select(-SITEID, -SITE_ID), by = join_by(site))
```

::: {.callout-important}

I'm not sure if this is correct, but these are the [variables](https://fluxnet.org/data/fluxnet2015-dataset/fullset-data-product/) I'm using for fluxes:

- GPP: `GPP_NT_VUT_MEAN` ± `GPP_NT_VUT_SE` (units: gC m-2 y-1)
- NEE: `NEE_VUT_MEAN` ± `NEE_VUT_SE` (units: gC m-2 y-1	)
- RECO: `RECO_NT_VUT_MEAN` ± `RECO_NT_VUT_SE` (units: gC m-2 y-1)
- ET: ???

```{r}
vars_of_interest <- c(
  "GPP_NT_VUT_MEAN",
  "NEE_VUT_MEAN",
  "RECO_NT_VUT_MEAN"
)
```

:::

TODO: Not sure where the QC variables are, but those would be nice to have.  I think we want to remove all the (poorly) gap-filled data.

## Maps to compare "historical" with "recent"

I don't know if there is an established time range for a "historical" period but I guess I'll go with 1981--2020 for now.

```{r}
annual$year %>% range()
annual_historic <- annual %>%
  group_by(site) %>%
  filter(year %in% 1981:2020) %>%
  summarize(
    across(any_of(matches(vars_of_interest)), \(x) mean(x, na.rm = TRUE))
  ) %>%
  #some sites apparently have no data in this range
  filter(if_all(all_of(vars_of_interest), is.finite))

annual_recent <- annual %>%
  group_by(site) %>%
  filter(year > 2020) %>%
  summarize(across(any_of(matches(vars_of_interest)), \(x) {
    mean(x, na.rm = TRUE)
  })) %>%
  filter(if_all(all_of(vars_of_interest), is.finite))

#get a single dataset with historical, recent, and differences
plot_df <- bind_rows(
  annual_historic %>% mutate(period = "hist"),
  annual_recent %>% mutate(period = "recent")
) %>%
  pivot_longer(c(-site, -period)) %>%
  pivot_wider(names_from = "period", values_from = "value") %>%
  mutate(diff = recent - hist) %>%
  pivot_wider(names_from = name, values_from = c(hist, recent, diff)) %>%
  #join in lat lon
  left_join(metadata %>% select(site, LOCATION_LAT, LOCATION_LONG))
```




Plot of historical data

```{r}
plot_df_sf <- sf::st_as_sf(
  plot_df,
  coords = c("LOCATION_LONG", "LOCATION_LAT")
)
world <- ne_countries() %>%
  st_set_crs("4326") %>%
  filter(continent != "Antarctica")

#TODO different color palettes for different variables?
p_hist <- map(glue::glue("hist_{vars_of_interest}"), \(var) {
  lab <- str_extract(var, "GPP|NEE|RECO")
  plot_df_sf %>%
    filter(if_all(all_of(var), is.finite)) %>%
    ggplot() +
    geom_sf(data = world, fill = "white") +
    geom_sf(aes(color = .data[[var]]), na.rm = TRUE) +
    #   scale_color_continuous_diverging() +
    scale_color_binned_diverging() +
    coord_sf() +
    labs(
      subtitle = "1981-2020 mean",
      color = glue::glue("{lab} gC m<sup>-2</sup> y<sup>-1</sup>")
    ) +
    theme_bw() +
    theme(legend.title = element_markdown())
})
# p_hist
wrap_plots(p_hist, ncol = 1)

```


```{r}
p_recent <- map(glue::glue("recent_{vars_of_interest}"), \(var) {
  lab <- str_extract(var, "GPP|NEE|RECO")
  plot_df_sf %>%
    filter(if_all(all_of(var), is.finite)) %>%
    ggplot() +
    geom_sf(data = world, fill = "white") +
    geom_sf(aes(color = .data[[var]]), na.rm = TRUE) +
    #   scale_color_continuous_diverging() +
    scale_color_binned_diverging() +
    coord_sf() +
    labs(
      subtitle = "> 2020 mean",
      color = glue::glue("{lab} gC m<sup>-2</sup> y<sup>-1</sup>")
    ) +
    theme_bw() +
    theme(legend.title = element_markdown())
})
wrap_plots(p_recent, ncol = 1)
```


```{r}
p_diff <- map(glue::glue("diff_{vars_of_interest}"), \(var) {
  lab <- str_extract(var, "GPP|NEE|RECO")
  plot_df_sf %>%
    filter(if_all(all_of(var), is.finite)) %>%
    ggplot() +
    geom_sf(data = world, fill = "white") +
    geom_sf(aes(color = .data[[var]]), na.rm = TRUE) +
    #   scale_color_continuous_diverging() +
    scale_color_binned_diverging() +
    coord_sf() +
    labs(
      subtitle = "recent - historic",
      color = glue::glue("{lab} gC m<sup>-2</sup> y<sup>-1</sup>")
    ) +
    theme_bw() +
    theme(legend.title = element_markdown())
})
wrap_plots(p_diff, ncol = 1)
```


## Timeseries of anomalies

E.g. one site:
```{r}
#| fig-height: 5
monthly %>%
  filter(site == "US-Ha1") %>%
  ggplot(aes(x = yearmonth, y = GPP_NT_VUT_MEAN)) +
  geom_line()
```

Calculate anomalies as the difference at each yearmonth from the average for that month (at each site?)

```{r}
anomalies <-
  monthly %>%
  select(yearmonth, site, all_of(vars_of_interest)) %>%
  mutate(month = month(yearmonth), .before = yearmonth) %>%
  mutate(
    across(all_of(vars_of_interest), \(x) x - mean(x, na.rm = TRUE)),
    .by = c(site, month)
  )
```

E.g. one site:

```{r}
#| fig-height: 5
anomalies %>%
  filter(site == "US-Ha1", !is.na(GPP_NT_VUT_MEAN)) %>%
  ggplot(aes(x = yearmonth, y = GPP_NT_VUT_MEAN)) +
  geom_line(aes(color = GPP_NT_VUT_MEAN > 0, group = 1)) #TODO: find better way to color anomalies
```